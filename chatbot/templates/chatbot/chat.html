{% extends "chatbot/base.html" %}
{% load static %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <!-- Lista de conversaciones -->
        <div class="col-md-3">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">Conversaciones</h5>
                </div>
                <div class="card-body p-0">
                    <div class="list-group list-group-flush" id="conversations-list">
                        {% for conversation in conversations %}
                        <div class="list-group-item list-group-item-action d-flex justify-content-between align-items-center conversation-item"
                             data-conversation-id="{{ conversation.id }}">
                            <span class="conversation-title">{{ conversation.title }}</span>
                            <button class="btn btn-danger btn-sm delete-conversation" data-id="{{ conversation.id }}">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>

        <!-- Área de chat -->
        <div class="col-md-9">
            <div class="card">
                <div class="card-body">
                    <div id="messages" class="mb-3 chat-messages" style="height: 500px; overflow-y: auto;"></div>
                    <form id="chat-form" class="mt-3">
                        {% csrf_token %}
                        <div class="input-group">
                            <input type="text" id="message-input" class="form-control" placeholder="Escribe tu mensaje...">
                            <button type="submit" class="btn btn-primary">Enviar</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<style>
    .chat-messages {
        padding: 1rem;
    }
    
    .message {
        margin-bottom: 1rem;
        display: flex;
    }
    
    .user-message {
        justify-content: flex-end;
    }
    
    .assistant-message {
        justify-content: flex-start;
    }
    
    .message-content {
        max-width: 70%;
        padding: 0.75rem 1rem;
        border-radius: 1rem;
        white-space: pre-wrap;
        word-wrap: break-word;
    }
    
    .user-message .message-content {
        background-color: #007bff;
        color: white;
        border-bottom-right-radius: 0.25rem;
    }
    
    .assistant-message .message-content {
        background-color: #f8f9fa;
        color: black;
        border-bottom-left-radius: 0.25rem;
    }
</style>
<script>
// Mostrar información de depuración al cargar la página
console.log('%c=== Información de Depuración del Sistema ===', 'color: blue; font-weight: bold;');
const debugInfo = JSON.parse('{{ debug_info|escapejs }}');

console.log('%cInformación del Usuario:', 'color: green; font-weight: bold;');
console.table(debugInfo.user_info);

console.log('%cInformación de la API:', 'color: purple; font-weight: bold;');
console.table(debugInfo.api_info);

console.log('%cInformación del Sistema:', 'color: orange; font-weight: bold;');
console.table(debugInfo.system_info);

let currentConversationId = null;

async function sendMessage(event) {
    event.preventDefault(); // Prevenir el comportamiento por defecto del formulario
    
    const messageInput = document.getElementById('message-input');
    const message = messageInput.value.trim();
    
    if (!message) return;
    
    // Deshabilitar el input y el botón mientras se envía el mensaje
    messageInput.disabled = true;
    const sendButton = document.querySelector('button[type="submit"]');
    if (sendButton) sendButton.disabled = true;
    
    try {
        // Obtener el token CSRF
        const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value;
        
        // Mostrar el mensaje del usuario inmediatamente
        appendMessage('user', message);
        
        // Limpiar el input
        messageInput.value = '';
        
        // Enviar el mensaje al servidor
        const response = await fetch('/chat/message/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrftoken,
            },
            body: JSON.stringify({
                message: message,
                conversation_id: currentConversationId
            })
        });

        console.log('Status de la respuesta:', response.status);
        const data = await response.json();
        console.log('Datos de la respuesta:', data);

        if (!response.ok) {
            throw new Error(data.error || 'Error al enviar el mensaje');
        }

        // Mostrar la respuesta del asistente
        if (data.response) {
            appendMessage('assistant', data.response);
        }
        
        // Actualizar el ID de la conversación si es necesario
        if (data.conversation_id) {
            currentConversationId = data.conversation_id;
        }
        
    } catch (error) {
        console.error(' Error en sendMessage:', error);
        alert('Error al enviar el mensaje: ' + error.message);
    } finally {
        // Rehabilitar el input y el botón
        messageInput.disabled = false;
        if (sendButton) sendButton.disabled = false;
        messageInput.focus();
    }
}

// Función para agregar mensajes al chat
function appendMessage(role, content) {
    const chatMessages = document.querySelector('.chat-messages');
    const messageDiv = document.createElement('div');
    messageDiv.className = `message ${role}-message`;
    
    // Crear el contenedor del mensaje
    const messageContent = document.createElement('div');
    messageContent.className = 'message-content';
    messageContent.textContent = content;
    
    messageDiv.appendChild(messageContent);
    chatMessages.appendChild(messageDiv);
    
    // Scroll al último mensaje
    chatMessages.scrollTop = chatMessages.scrollHeight;
}

// Agregar el event listener al formulario
document.getElementById('chat-form').addEventListener('submit', sendMessage);
        
// Mantener el foco en el input
document.getElementById('message-input').focus();

async function loadConversation(conversationId) {
    try {
        const response = await fetch(`/chat/history/${conversationId}/`);
        if (!response.ok) {
            throw new Error('Error al cargar la conversación');
        }
        
        const data = await response.json();
        document.getElementById('messages').innerHTML = '';
        currentConversationId = conversationId;
        
        // Resaltar la conversación activa
        document.querySelectorAll('.conversation-item').forEach(item => {
            item.classList.remove('active');
            if (item.dataset.conversationId === conversationId) {
                item.classList.add('active');
            }
        });
        
        data.messages.forEach(msg => {
            appendMessage(msg.role, msg.content);
        });
    } catch (error) {
        console.error('Error al cargar conversación:', error);
        alert('Error al cargar la conversación');
    }
}

// Event delegation para las conversaciones
document.getElementById('conversations-list').addEventListener('click', (e) => {
    const conversationItem = e.target.closest('.conversation-item');
    if (conversationItem && !e.target.classList.contains('delete-conversation')) {
        const conversationId = conversationItem.dataset.conversationId;
        loadConversation(conversationId);
    }
});

// Event delegation para eliminar conversaciones
document.getElementById('conversations-list').addEventListener('click', async (e) => {
    const deleteButton = e.target.closest('.delete-conversation');
    if (deleteButton) {
        e.stopPropagation();
        const conversationId = deleteButton.dataset.id;
        
        if (confirm('¿Estás seguro de que deseas eliminar esta conversación?')) {
            try {
                const response = await fetch(`/chat/delete/${conversationId}/`, {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                    }
                });
                
                if (response.ok) {
                    const item = deleteButton.closest('.conversation-item');
                    item.remove();
                    if (currentConversationId === conversationId) {
                        currentConversationId = null;
                        document.getElementById('messages').innerHTML = '';
                    }
                } else {
                    throw new Error('Error al eliminar la conversación');
                }
            } catch (error) {
                console.error('Error al eliminar conversación:', error);
                alert('Error al eliminar la conversación');
            }
        }
    }
});
</script>
{% endblock %}
