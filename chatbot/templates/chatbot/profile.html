{% extends "chatbot/base.html" %}
{% load static %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'chatbot/css/themes.css' %}">
<style>
    .profile-picture-container {
        position: relative;
        width: 150px;
        height: 150px;
        margin: 0 auto;
    }
    
    .profile-picture {
        width: 100%;
        height: 100%;
        object-fit: cover;
        border-radius: 50%;
    }
    
    .profile-picture-overlay {
        position: absolute;
        bottom: 0;
        left: 0;
        right: 0;
        background: rgba(0, 0, 0, 0.5);
        overflow: hidden;
        width: 100%;
        height: 0;
        transition: .5s ease;
        border-bottom-left-radius: 50%;
        border-bottom-right-radius: 50%;
    }
    
    .profile-picture-container:hover .profile-picture-overlay {
        height: 50%;
    }
</style>
{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row">
        <div class="col-md-8 mx-auto">
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h4 class="mb-0">Perfil de Usuario</h4>
                </div>
                <div class="card-body">
                    <form method="post" enctype="multipart/form-data" id="profile-form">
                        {% csrf_token %}
                        
                        <!-- Foto de perfil -->
                        <div class="text-center mb-4">
                            <div class="profile-picture-container">
                                <img src="{{ user.userprofile.get_profile_picture_url }}" alt="Profile Picture" class="profile-picture" id="profile-picture-preview">
                                <div class="profile-picture-overlay d-flex align-items-center justify-content-center">
                                    <label for="id_profile_picture" class="btn btn-light btn-sm">
                                        <i class="fas fa-camera"></i> Cambiar foto
                                    </label>
                                </div>
                            </div>
                            <input type="file" name="profile_picture" accept="image/*" id="id_profile_picture" style="display: none;" onchange="previewImage(this);">
                        </div>

                        <!-- Información básica -->
                        <div class="mb-4">
                            <h5>Información Básica</h5>
                            <div class="mb-3">
                                <label class="form-label">Nombre</label>
                                <input type="text" class="form-control" name="first_name" 
                                       value="{{ user.first_name }}">
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Apellido</label>
                                <input type="text" class="form-control" name="last_name" 
                                       value="{{ user.last_name }}">
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Biografía</label>
                                <textarea class="form-control" name="bio" rows="3">{{ profile.bio }}</textarea>
                            </div>
                        </div>

                        <!-- Preferencias de apariencia -->
                        <div class="mb-4">
                            <h5>Preferencias de Apariencia</h5>
                            <div class="mb-3">
                                <label class="form-label">Tema</label>
                                <select class="form-select" name="theme" id="theme-selector">
                                    {% for value, label in profile.THEME_CHOICES %}
                                    <option value="{{ value }}" {% if profile.theme == value %}selected{% endif %}>
                                        {{ label }}
                                    </option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Tamaño de fuente</label>
                                <select class="form-select" name="font_size" id="font-size-selector">
                                    {% for value, label in profile.FONT_SIZE_CHOICES %}
                                    <option value="{{ value }}" {% if profile.font_size == value %}selected{% endif %}>
                                        {{ label }}
                                    </option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>

                        <!-- Preferencias de notificación -->
                        <div class="mb-4">
                            <h5>Preferencias de Notificación</h5>
                            <div class="form-check mb-2">
                                <input type="checkbox" class="form-check-input" name="email_notifications" 
                                       id="email-notifications" {% if profile.email_notifications %}checked{% endif %}>
                                <label class="form-check-label" for="email-notifications">
                                    Recibir notificaciones por email
                                </label>
                            </div>
                            <div class="form-check">
                                <input type="checkbox" class="form-check-input" name="show_typing_status" 
                                       id="typing-status" {% if profile.show_typing_status %}checked{% endif %}>
                                <label class="form-check-label" for="typing-status">
                                    Mostrar estado de escritura
                                </label>
                            </div>
                        </div>

                        <div class="text-end">
                            <a href="{% url 'chatbot:chatbot_chat_home' %}" class="btn btn-secondary me-2" id="btn-volver">Volver</a>
                            <button type="submit" class="btn btn-primary">Guardar Cambios</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    let formModified = false;

    // Función para marcar el formulario como modificado
    function markFormAsModified() {
        formModified = true;
    }

    // Detectar cambios en todos los campos del formulario
    const formInputs = document.querySelectorAll('#profile-form input, #profile-form textarea, #profile-form select');
    formInputs.forEach(input => {
        input.addEventListener('change', markFormAsModified);
    });

    // Función para aplicar el tema en tiempo real
    document.getElementById('theme-selector').addEventListener('change', function(e) {
        applyTheme(e.target.value);
        markFormAsModified();
    });

    // Función para aplicar el tamaño de fuente en tiempo real
    document.getElementById('font-size-selector').addEventListener('change', function(e) {
        applyFontSize(e.target.value);
        markFormAsModified();
    });

    // Manejar la subida de la foto de perfil
    document.querySelector('input[name="profile_picture"]').addEventListener('change', function() {
        if (this.files && this.files[0]) {
            const reader = new FileReader();
            reader.onload = function(e) {
                document.querySelector('.profile-picture').src = e.target.result;
            };
            reader.readAsDataURL(this.files[0]);
            markFormAsModified();
        }
    });

    // Manejar el botón de volver
    document.getElementById('btn-volver').addEventListener('click', function(e) {
        if (formModified) {
            e.preventDefault();
            if (confirm('Hay cambios sin guardar. ¿Deseas guardar los cambios antes de salir?')) {
                document.getElementById('profile-form').submit();
            } else {
                window.location.href = this.href;
            }
        }
    });

    // Manejar el envío del formulario
    document.getElementById('profile-form').addEventListener('submit', function(e) {
        e.preventDefault();
        
        const formData = new FormData(this);
        
        fetch('{% url "chatbot:chatbot_profile" %}', {
            method: 'POST',
            body: formData,
            headers: {
                'X-Requested-With': 'XMLHttpRequest'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                formModified = false;
                // Recargar la página para aplicar todos los cambios
                window.location.reload();
            }
        })
        .catch(error => {
            console.error('Error:', error);
        });
    });

    // Detectar si el usuario intenta salir de la página con cambios sin guardar
    window.addEventListener('beforeunload', function(e) {
        if (formModified) {
            e.preventDefault();
            e.returnValue = ''; // Mensaje estándar del navegador
        }
    });

    function previewImage(input) {
        if (input.files && input.files[0]) {
            const reader = new FileReader();
            reader.onload = function(e) {
                document.getElementById('profile-picture-preview').src = e.target.result;
            };
            reader.readAsDataURL(input.files[0]);
        }
    }
</script>
{% endblock %}
